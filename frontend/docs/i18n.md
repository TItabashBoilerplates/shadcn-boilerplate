# 多言語対応（i18n）ガイド

このプロジェクトは `next-intl` を使用して、Feature Sliced Design (FSD) の原則に則った多言語対応を実装しています。

## 概要

- **サポート言語**: 英語 (en)、日本語 (ja)
- **デフォルト言語**: 英語 (en)
- **使用ライブラリ**: next-intl v4.4.0
- **アーキテクチャ**: Feature Sliced Design (FSD) に準拠

## ディレクトリ構造

```
frontend/
├── src/
│   ├── app/
│   │   ├── [locale]/          # ロケールごとのルート
│   │   │   ├── layout.tsx     # ロケールレイアウト
│   │   │   └── page.tsx       # ロケールページ
│   │   ├── layout.tsx         # ルートレイアウト（最小限）
│   │   ├── page.tsx           # ルートページ（404）
│   │   └── not-found.tsx      # 404 ページ
│   ├── views/                 # FSD の pages レイヤー（Next.js Pages Router と競合しないよう views に命名）
│   │   └── home/
│   └── shared/
│       ├── config/
│       │   └── i18n/
│       │       ├── messages/  # 翻訳ファイル（FSD）
│       │       │   ├── en.json    # 英語翻訳
│       │       │   └── ja.json    # 日本語翻訳
│       │       ├── request.ts # next-intl リクエスト設定（FSD）
│       │       ├── routing.ts # ルーティング設定（FSD）
│       │       └── index.ts   # パブリック API
│       └── lib/
│           └── i18n/
│               ├── navigation.ts # ナビゲーションラッパー（FSD）
│               └── index.ts      # パブリック API
└── middleware.ts              # Next.js ミドルウェア
```

### 重要な注意事項

**FSD の pages レイヤーを `views/` に配置する理由:**

Next.js の App Router を使用する場合、`src/pages/` ディレクトリは Pages Router として認識されます。これは FSD アーキテクチャの `pages` レイヤーと競合し、ビルドエラーの原因となります。そのため、FSD の pages レイヤーは `src/views/` に配置します。

- ✅ `src/views/` - FSD の pages レイヤー
- ❌ `src/pages/` - Next.js Pages Router として認識されるため使用不可
- ✅ `src/app/` - Next.js App Router

## 使用方法

### 1. 翻訳の使用（Client Components）

```tsx
'use client'

import { useTranslations } from 'next-intl'

export function MyComponent() {
  const t = useTranslations('MyNamespace')

  return <h1>{t('title')}</h1>
}
```

### 2. 翻訳の使用（Server Components）

```tsx
import { getTranslations } from 'next-intl/server'

export default async function MyServerComponent() {
  const t = await getTranslations('MyNamespace')

  return <h1>{t('title')}</h1>
}
```

### 3. ロケール対応のナビゲーション

FSD の `shared/lib/i18n` から提供されるナビゲーション API を使用します：

```tsx
// ❌ Next.js の Link を直接使用しない
import Link from 'next/link'

// ✅ ロケール対応の Link を使用
import { Link } from '@/shared/lib/i18n'

export function Navigation() {
  return (
    <nav>
      <Link href="/about">About</Link>  {/* 自動的に /en/about または /ja/about になる */}
    </nav>
  )
}
```

### 4. プログラマティックなナビゲーション

```tsx
'use client'

import { useRouter } from '@/shared/lib/i18n'

export function MyComponent() {
  const router = useRouter()

  const handleClick = () => {
    router.push('/dashboard')  // 現在のロケールが保持される
  }

  return <button onClick={handleClick}>Go to Dashboard</button>
}
```

### 5. 現在のパス名の取得

```tsx
'use client'

import { usePathname } from '@/shared/lib/i18n'

export function MyComponent() {
  const pathname = usePathname()  // '/dashboard' (ロケールプレフィックスなし)

  return <div>Current path: {pathname}</div>
}
```

### 6. Server-side のリダイレクト

```tsx
import { redirect } from '@/shared/lib/i18n'

export default async function MyPage() {
  const user = await getUser()

  if (!user) {
    redirect('/login')  // 現在のロケールが保持される
  }

  return <div>Welcome {user.name}</div>
}
```

## 翻訳ファイルの管理

### src/shared/config/i18n/messages/en.json

```json
{
  "common": {
    "welcome": "Welcome",
    "save": "Save",
    "cancel": "Cancel"
  },
  "HomePage": {
    "title": "Welcome to Next.js!",
    "description": "Get started by editing the page."
  }
}
```

### src/shared/config/i18n/messages/ja.json

```json
{
  "common": {
    "welcome": "ようこそ",
    "save": "保存",
    "cancel": "キャンセル"
  },
  "HomePage": {
    "title": "Next.jsへようこそ！",
    "description": "ページを編集して始めましょう。"
  }
}
```

## 新しい言語の追加

1. `src/shared/config/i18n/routing.ts` にロケールを追加：

```typescript
export const routing = defineRouting({
  locales: ['en', 'ja', 'fr'],  // フランス語を追加
  defaultLocale: 'en',
})
```

2. `src/shared/config/i18n/messages/fr.json` を作成：

```json
{
  "common": {
    "welcome": "Bienvenue",
    "save": "Enregistrer",
    "cancel": "Annuler"
  }
}
```

3. `src/app/[locale]/layout.tsx` の `generateStaticParams` が自動的に新しいロケールを含めます。

## FSD における i18n の配置

### shared/config/i18n

- **目的**: アプリケーション全体で共有される i18n の設定
- **内容**: ルーティング設定、サポートする言語のリスト
- **使用例**: `routing.ts`, `index.ts`

### shared/lib/i18n

- **目的**: ロケール対応のユーティリティ関数
- **内容**: ナビゲーションラッパー、その他のヘルパー関数
- **使用例**: `navigation.ts`, `index.ts`

### shared/config/i18n/messages/

- **目的**: 翻訳ファイルの保存
- **内容**: 各言語の JSON ファイル
- **配置理由**: FSD の shared/config に配置（設定ファイルの一部として扱う）

### shared/config/i18n/request.ts

- **目的**: next-intl のリクエスト設定
- **内容**: メッセージの読み込みロジック
- **配置理由**: FSD の shared/config に配置（next.config.ts でパスを指定）

## ベストプラクティス

### 1. 翻訳キーの命名規則

```json
{
  "namespace": {
    "key": "value",
    "nestedKey": {
      "subKey": "value"
    }
  }
}
```

### 2. 名前空間の使用

コンポーネントごとに適切な名前空間を使用：

```tsx
// HomePage コンポーネント
const t = useTranslations('HomePage')

// Navigation コンポーネント
const t = useTranslations('navigation')

// 共通の翻訳
const t = useTranslations('common')
```

### 3. TypeScript の型安全性

翻訳キーの型安全性を向上させるため、型定義を追加することができます：

```typescript
// src/shared/config/i18n/types.ts
export type TranslationKeys =
  | 'common.welcome'
  | 'common.save'
  | 'HomePage.title'
  // ...
```

### 4. パラメータを含む翻訳

```json
{
  "greeting": "Hello {name}!"
}
```

```tsx
const t = useTranslations('common')
<p>{t('greeting', { name: 'John' })}</p>
```

### 5. 複数形の処理

```json
{
  "items": "{count, plural, =0 {No items} =1 {One item} other {# items}}"
}
```

```tsx
const t = useTranslations('common')
<p>{t('items', { count: 5 })}</p>
```

## トラブルシューティング

### 翻訳が表示されない

1. `messages/{locale}.json` ファイルが存在するか確認
2. キーが正しいか確認
3. `NextIntlClientProvider` でラップされているか確認

### ロケールが切り替わらない

1. middleware.ts が正しく設定されているか確認
2. `src/shared/lib/i18n` のナビゲーション API を使用しているか確認
3. ブラウザのキャッシュをクリア

### ビルドエラー

1. `next-intl` が正しくインストールされているか確認: `bun add next-intl`
2. `next.config.ts` に next-intl プラグインが設定されているか確認

## 参考資料

- [next-intl 公式ドキュメント](https://next-intl-docs.vercel.app/)
- [Feature Sliced Design](https://feature-sliced.design/)
- [Next.js 国際化](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
