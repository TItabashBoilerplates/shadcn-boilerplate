/**
 * OpenAPI TypeScript å‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® OpenAPI ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ TypeScript å‹å®šç¾©ã‚’ç”Ÿæˆã™ã‚‹
 *
 * ä½¿ç”¨æ–¹æ³•:
 *   bun run scripts/generate.ts
 *
 * ç’°å¢ƒå¤‰æ•°:
 *   BACKEND_URL - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ã® URL (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: http://127.0.0.1:4040)
 */

import { existsSync } from 'node:fs'
import { dirname, join } from 'node:path'
import { fileURLToPath } from 'node:url'
import { $ } from 'bun'

const __dirname = dirname(fileURLToPath(import.meta.url))
const packageDir = join(__dirname, '..')
const outputPath = join(packageDir, 'src', 'schema.d.ts')

// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ URL ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼‰
const backendUrl =
  process.env.BACKEND_URL ?? process.env.NEXT_PUBLIC_BACKEND_PY_URL ?? 'http://127.0.0.1:4040'
const openapiUrl = `${backendUrl}/openapi.json`

async function checkBackendAvailable(): Promise<boolean> {
  try {
    const response = await fetch(`${backendUrl}/healthcheck`, {
      method: 'GET',
      signal: AbortSignal.timeout(5000),
    })
    return response.ok
  } catch {
    return false
  }
}

async function generate() {
  console.log('ğŸ” Checking backend availability...')
  console.log(`   Backend URL: ${backendUrl}`)

  const isAvailable = await checkBackendAvailable()

  if (!isAvailable) {
    console.warn('âš ï¸  Backend is not available. Skipping type generation.')
    console.warn('   Make sure the backend is running: make run')

    // æ—¢å­˜ã®ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
    if (existsSync(outputPath)) {
      console.log('â„¹ï¸  Using existing schema.d.ts')
      return
    }

    // ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    console.log('ğŸ“ Creating placeholder schema.d.ts')
    await Bun.write(
      outputPath,
      `// Auto-generated by openapi-typescript
// This is a placeholder file. Run 'bun run generate' with backend running to generate actual types.

export interface paths {}
export interface components {}
export interface operations {}
export type external = Record<string, never>
`
    )
    return
  }

  console.log('âœ… Backend is available')
  console.log(`ğŸš€ Generating types from ${openapiUrl}...`)

  try {
    // openapi-typescript CLI ã‚’ä½¿ç”¨ã—ã¦å‹ã‚’ç”Ÿæˆ
    await $`bunx openapi-typescript ${openapiUrl} -o ${outputPath}`
    console.log(`âœ¨ Generated: ${outputPath}`)
  } catch (error) {
    console.error('âŒ Failed to generate types:', error)
    process.exit(1)
  }
}

generate()
