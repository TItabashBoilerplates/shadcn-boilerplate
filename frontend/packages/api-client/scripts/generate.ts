/**
 * Hey API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® OpenAPI ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ TypeScript SDK ã¨ TanStack Query hooks ã‚’ç”Ÿæˆã™ã‚‹
 *
 * ä½¿ç”¨æ–¹æ³•:
 *   bun run scripts/generate.ts
 *
 * ç’°å¢ƒå¤‰æ•°:
 *   BACKEND_URL - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ã® URL (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: http://127.0.0.1:4040)
 */

import { existsSync, mkdirSync } from 'node:fs'
import { dirname, join } from 'node:path'
import { fileURLToPath } from 'node:url'
import { $ } from 'bun'

const __dirname = dirname(fileURLToPath(import.meta.url))
const packageDir = join(__dirname, '..')
const outputDir = join(packageDir, 'src', 'generated')

// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ URL ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼‰
const backendUrl =
  process.env.BACKEND_URL ?? process.env.NEXT_PUBLIC_BACKEND_PY_URL ?? 'http://127.0.0.1:4040'

async function checkBackendAvailable(): Promise<boolean> {
  try {
    const response = await fetch(`${backendUrl}/healthcheck`, {
      method: 'GET',
      signal: AbortSignal.timeout(5000),
    })
    return response.ok
  } catch {
    return false
  }
}

function createPlaceholderFiles(): void {
  // å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
  if (!existsSync(outputDir)) {
    mkdirSync(outputDir, { recursive: true })
  }

  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
  const typesContent = `// Auto-generated by @hey-api/openapi-ts
// This is a placeholder file. Run 'bun run generate' with backend running to generate actual types.

export type {}
`

  const sdkContent = `// Auto-generated by @hey-api/openapi-ts
// This is a placeholder file. Run 'bun run generate' with backend running to generate actual SDK.

export {}
`

  Bun.write(join(outputDir, 'types.gen.ts'), typesContent)
  Bun.write(join(outputDir, 'sdk.gen.ts'), sdkContent)
  console.log('   Created placeholder files in src/generated/')
}

async function generate(): Promise<void> {
  console.log('ğŸ” Checking backend availability...')
  console.log(`   Backend URL: ${backendUrl}`)

  const isAvailable = await checkBackendAvailable()

  if (!isAvailable) {
    console.warn('âš ï¸  Backend is not available. Skipping client generation.')
    console.warn('   Make sure the backend is running: make run')

    // æ—¢å­˜ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
    if (existsSync(join(outputDir, 'types.gen.ts'))) {
      console.log('â„¹ï¸  Using existing generated files')
      return
    }

    // ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
    console.log('ğŸ“ Creating placeholder files')
    createPlaceholderFiles()
    return
  }

  console.log('âœ… Backend is available')
  console.log(`ğŸš€ Generating SDK from ${backendUrl}/openapi.json...`)

  try {
    // Hey API CLI ã‚’ä½¿ç”¨ã—ã¦ SDK ã‚’ç”Ÿæˆ
    await $`bunx @hey-api/openapi-ts`
    console.log(`âœ¨ Generated SDK in ${outputDir}`)
  } catch (error) {
    console.error('âŒ Failed to generate SDK:', error)
    process.exit(1)
  }
}

generate()
